import logging, os
from aiogram import Bot, Dispatcher, executor, types
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from database import get_user, users_col
import markups as nav

API_TOKEN = os.getenv("BOT_TOKEN")
ADMIN_ID = 863961919

bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot, storage=MemoryStorage())

@dp.message_handler(commands=['start'])
async def start(message: types.Message):
    referrer = message.get_args()
    user = await get_user(message.from_user.id, referrer)
    
    # Ø§Ú¯Ø± Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ú©Ø³ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
    if referrer and int(referrer) != message.from_user.id:
        try:
            await bot.send_message(referrer, f"ğŸ”” Ú©Ø§Ø±Ø¨Ø± {message.from_user.id} Ø¨Ø§ Ù„ÛŒÙ†Ú© Ø´Ù…Ø§ ÙˆØ§Ø±Ø¯ Ø´Ø¯.")
        except: pass

    await message.answer("Ù„Ø·ÙØ§Ù‹ ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=nav.main_menu())

@dp.callback_query_handler(lambda c: c.data == "account")
async def account(callback: types.CallbackQuery):
    u = await get_user(callback.from_user.id)
    text = (f"ğŸ‘¤ Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ: {u['user_id']}\n"
            f"ğŸ” ÙˆØ¶Ø¹ÛŒØª: ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ\n"
            f"ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„: {u['wallet']:,} ØªÙˆÙ…Ø§Ù†\n"
            f"ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒÙ‡Ø§: 0\n\n"
            f"ğŸ“† ØªØ§Ø±ÛŒØ® Ø¹Ø¶ÙˆÛŒØª: {u['join_date']}")
    
    kb = types.InlineKeyboardMarkup(row_width=1)
    kb.add(types.InlineKeyboardButton("â• Ø§ÙØ²Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ", callback_data="charge_wallet"),
           types.InlineKeyboardButton("ğŸ‘¥ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒÚ¯ÛŒØ±ÛŒ", callback_data="ref_link"),
           types.InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="main_menu"))
    await callback.message.edit_text(text, reply_markup=kb)

@dp.callback_query_handler(lambda c: c.data == "main_menu")
async def back_main(callback: types.CallbackQuery):
    await callback.message.edit_text("Ù„Ø·ÙØ§Ù‹ ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=nav.main_menu())

if __name__ == '__main__':
    executor.start_polling(dp, skip_updates=True)
